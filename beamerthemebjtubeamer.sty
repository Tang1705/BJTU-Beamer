%%
%% This is file `beamerthemebjtubeamer.sty'
%%
%% ------------------------------------------------------------------------
%% Copyright (C) 2021,2022 Q.Tang
%% 
%% Licensed under the Apache License, Version 2.0 (the "License");
%% you may not use this file except in compliance with the License.
%% You may obtain a copy of the License at
%% 
%%     http://www.apache.org/licenses/LICENSE-2.0
%% 
%% Unless required by applicable law or agreed to in writing, software
%% distributed under the License is distributed on an "AS IS" BASIS,
%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
%% See the License for the specific language governing permissions and
%% limitations under the License.
%% ------------------------------------------------------------------------

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{beamerthemebjtubeamer}

\useinnertheme{bjtubeamer}
\usecolortheme{bjtubeamer}
\usefonttheme{bjtubeamer}

% Requirement
\RequirePackage{xcolor}
\RequirePackage{tokenizer}
\RequirePackage{tikz}
\RequirePackage{xcolor}
\RequirePackage{graphicx}
\RequirePackage{fontspec}
\RequirePackage{etoolbox}
\RequirePackage{amsmath}
\RequirePackage{mathtools}
\RequirePackage{hyperref}
\RequirePackage{fontawesome}

%OverWrite MakeTitle and TitlePage
\newtoggle{tpage} % note: toggles are false by default

\let\originalmaketitle\maketitle
\renewcommand{\maketitle}{
    \global\toggletrue{tpage}
    \originalmaketitle
    \global\togglefalse{tpage}
}

\AtBeginEnvironment{titlepage}{\global\toggletrue{tpage}}

\newcommand\background[1]{%
\begin{tikzpicture}[remember picture,overlay]
\node[inner sep=0pt,outer sep=0pt,opacity=1]
  at (current page.center)
  {\includegraphics[width=\paperwidth,height=\paperheight]{#1}};
\end{tikzpicture}%
}

\newtoggle{cpage} % note: toggles are false by default
\newcommand{\makecontent}{
    \global\toggletrue{cpage}
    \begin{frame}
    \background{./resources/img/content.png}
    \addtocounter{framenumber}{-2}
    \vspace{-0.8cm}
	\begin{columns}
		\begin{column}{.60\linewidth}
		\end{column}
		\begin{column}{.40\linewidth}
			\tableofcontents[sectionstyle=show, hideallsubsections]
		\end{column}
	\end{columns}
	\end{frame}
    \global\togglefalse{cpage}
}

\AtBeginEnvironment{titlepage}{\global\toggletrue{cpage}}

\newtoggle{cover} % note: toggles are false by default

\let\originalsection\section
\renewcommand{\section}[1]{
    \global\toggletrue{cover}
    \begin{frame}[t]

	\originalsection{#1}
	\background{./resources/img/cover\thesection.png}
	\begin{tikzpicture}[remember picture,overlay]
    	\node[xshift=10cm,yshift=4.7cm] at (current page.south west) {\fontsize{30}{48} {\bfseries\color{black}\selectfont #1}};
    \end{tikzpicture}		
    
    \vskip 3.4cm
    \begin{columns}
		\begin{column}{.60\linewidth}
		\end{column}
		\begin{column}{.40\linewidth}
			\tableofcontents[currentsection, sectionstyle=hide,subsectionstyle=show/show/hide]
		\end{column}
	\end{columns}
	\end{frame}
    \global\togglefalse{cover}
}

%\AtBeginEnvironment{titlepage}{\global\toggletrue{cover}}

\newtoggle{backcover} % note: toggles are false by default
\newcommand{\makebackcover}{
    \global\toggletrue{backcover}
    \begin{frame}
    \background{./resources/img/backcover.png}
    \begin{tikzpicture}[remember picture,overlay]
    	\node[xshift=-2.8cm,yshift=4.1cm] at (current page.south east) {\usebeamerfont{author}答辩人：\bjtu@value@author};
    	\node[xshift=-2.8cm,yshift=3.4cm] at (current page.south east) {\usebeamerfont{author}指导教师：\bjtu@value@advisor};
    \end{tikzpicture}
    
    \begin{columns}
		\begin{column}{.60\linewidth}
		
		\end{column}
		\begin{column}{.40\linewidth}
		\end{column}
	\end{columns}
    
    \end{frame}
    \global\togglefalse{backcover}
}

%\AtBeginEnvironment{titlepage}{\global\toggletrue{backcover}}

% Variables
\newcommand{\bjtuDefaults}{
    \def \bjtutitlebackground {./resources/img/bg.png}
    \def \bjtutitlebackgroundmove {0,.79cm} %-.1mm, -.1mm
    \def \bjtutitlelogo {./resources/vi/logo.png}
    \def \bjtutitlelogoheight {12mm}
    \def \bjtutitlelogomove {\the\paperwidth-110mm,\the\paperheight+3mm}
	\def \bjtutitleleftlogo {./resources/vi/logo_left.png}
	\def \bjtutitlerightlogo {./resources/vi/logo_right.png}
	\def \bjtutitleleftlogoheight {5mm}
	\def \bjtutitlerightlogoheight {4mm}
	\def \bjtutitleleftlogomove {\the\paperwidth-143mm,\the\paperheight-22.5mm}
	\def \bjtutitlerightlogomove {\the\paperwidth-73mm,\the\paperheight-23mm}
    \def \bjtutitlefak {}
    \def \bjtufak{}
    \def \bjtuorange {bjtuorange} 
    \def \bjtutoplogo {./resources/vi/logo.png}
    \def \bjtutop {./resources/img/header.png} 
}

\bjtuDefaults

%定义使用者需要填写的标签
\def\bjtu@label@institution{学院名称:~}
\def\bjtu@label@author{作者姓名:~}
\def\bjtu@label@studentNumber{学~~~~~~号:~}
\def\bjtu@label@advisor{导师姓名:~}
\def\bjtu@label@defense{答辩:~}

%定义上述标签的默认值
\def\bjtu@value@institution{XXXX}
\def\bjtu@value@author{XXXX}
\def\bjtu@value@studentNumber{XXXX}
\def\bjtu@value@advisor{XXXX}
\def\bjtu@value@defense{XXXX}
\def\bjtu@value@title{中文题目}
\def\bjtu@value@englishtitle{}

%定义用户填写上述标签对应值的命令,需要用户在主文档自行调用
\newcommand\institution[1]{\def\bjtu@value@institution{#1}}
\renewcommand\author[1]{\def\bjtu@value@author{#1}}
\newcommand\studentNumber[1]{\def\bjtu@value@studentNumber{#1}}
\newcommand\advisor[1]{\def\bjtu@value@advisor{#1}}
\newcommand\defense[1]{\def\bjtu@value@defense{#1}}
\newcommand\englishtitle[1]{\def\bjtu@value@englishtitle{#1}}
\renewcommand\title[1]{\def\bjtu@value@title{#1}}

\renewcommand{\today}{\number\year/\number\month/\number\day}